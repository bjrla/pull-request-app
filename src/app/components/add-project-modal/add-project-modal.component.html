<div class="modal-backdrop" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" (click)="onCancel()" type="button">×</button>
    </div>

    <div class="modal-body">
      <!-- Current Projects List -->
      <div class="current-projects-section">
        <h3>Current Projects</h3>
        @if (currentProjects.length === 0) {
        <p class="no-projects">No projects configured yet.</p>
        } @else {
        <div class="projects-list">
          @for (project of currentProjects; track project.name; let i = $index)
          {
          <!-- Drop indicator above each item -->
          <div
            class="drop-indicator"
            [class.show]="
              dropIndicatorIndex === i &&
              draggedIndex !== -1 &&
              draggedIndex !== i
            "
            (dragover)="onDragOver($event, i)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, i)"
          ></div>

          <div
            class="project-item"
            [class.dragging]="draggedIndex === i"
            [class.drag-over]="dropIndicatorIndex === i && draggedIndex !== -1"
            draggable="true"
            (dragstart)="onDragStart($event, i)"
            (dragover)="onDragOver($event, i)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, i)"
            (dragend)="onDragEnd()"
          >
            <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
            <div class="project-info" [class.hidden-project]="project.hidden">
              <div class="project-name">
                {{ project.name }}
                @if (project.hidden) {
                <span class="hidden-badge">Hidden</span>
                }
              </div>
              <div class="project-repo">{{ project.repository }}</div>
            </div>
            <div class="project-actions">
              <button
                class="toggle-visibility-btn"
                [class.show-btn]="project.hidden"
                [class.hide-btn]="!project.hidden"
                (click)="onToggleProjectVisibility(project.name)"
                [title]="project.hidden ? 'Show project' : 'Hide project'"
                type="button"
              >
                @if (project.hidden) {
                <!-- Show/Eye icon -->
                <svg viewBox="0 0 24 24" width="16" height="16">
                  <path
                    d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"
                    fill="currentColor"
                  />
                </svg>
                } @else {
                <!-- Hide/Eye-off icon -->
                <svg viewBox="0 0 24 24" width="16" height="16">
                  <path
                    d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.09L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.76,7.13 11.37,7 12,7Z"
                    fill="currentColor"
                  />
                </svg>
                }
              </button>
              <button
                class="remove-btn"
                (click)="onRemoveProject(project.name)"
                title="Remove project"
                type="button"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  x="0px"
                  y="0px"
                  width="16"
                  height="16"
                  viewBox="0,0,256,256"
                  style="fill: #ffffff"
                >
                  <g
                    fill="#ffffff"
                    fill-rule="nonzero"
                    stroke="none"
                    stroke-width="1"
                    stroke-linecap="butt"
                    stroke-linejoin="miter"
                    stroke-miterlimit="10"
                    stroke-dasharray=""
                    stroke-dashoffset="0"
                    font-family="none"
                    font-weight="none"
                    font-size="none"
                    text-anchor="none"
                    style="mix-blend-mode: normal"
                  >
                    <g transform="scale(8.53333,8.53333)">
                      <path
                        d="M13,3c-0.26757,-0.00363 -0.52543,0.10012 -0.71593,0.28805c-0.1905,0.18793 -0.29774,0.44436 -0.29774,0.71195h-5.98633c-0.36064,-0.0051 -0.69608,0.18438 -0.87789,0.49587c-0.18181,0.3115 -0.18181,0.69676 0,1.00825c0.18181,0.3115 0.51725,0.50097 0.87789,0.49587h18c0.36064,0.0051 0.69608,-0.18438 0.87789,-0.49587c0.18181,-0.3115 0.18181,-0.69676 0,-1.00825c-0.18181,-0.3115 -0.51725,-0.50097 -0.87789,-0.49587h-5.98633c0,-0.26759 -0.10724,-0.52403 -0.29774,-0.71195c-0.1905,-0.18793 -0.44836,-0.29168 -0.71593,-0.28805zM6,8v16c0,1.105 0.895,2 2,2h14c1.105,0 2,-0.895 2,-2v-16z"
                      ></path>
                    </g>
                  </g>
                </svg>
              </button>
            </div>
          </div>
          }

          <!-- Drop indicator at the end -->
          <div class="drop-indicator-container">
            <!-- Visual line indicator -->
            <div
              class="drop-indicator"
              [class.show]="
                dropIndicatorIndex === currentProjects.length &&
                draggedIndex !== -1
              "
            ></div>
            <!-- Invisible larger drop zone -->
            <div
              class="drop-zone-overlay"
              (dragover)="onDragOver($event, currentProjects.length)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event, currentProjects.length)"
            ></div>
          </div>
        </div>
        }
      </div>

      <!-- Add New Project Form -->
      <div class="add-project-section">
        <h3>Add New Project</h3>
        <form (ngSubmit)="onSubmit()" #projectForm="ngForm">
          <div class="form-group">
            <label for="repositoryUrl">Repository URL</label>
            <input
              type="url"
              id="repositoryUrl"
              name="repositoryUrl"
              [(ngModel)]="repositoryUrl"
              required
              placeholder="https://azuredevops.danskenet.net/Main/ProjectName/_git/RepositoryName"
              class="form-control"
            />
            <small class="form-help">
              Paste the Azure DevOps repository URL. The project and repository
              names will be extracted automatically.
            </small>
          </div>

          <button
            type="submit"
            class="btn btn-add"
            [disabled]="!projectForm.form.valid"
          >
            Add Project
          </button>
        </form>
      </div>

      <!-- Personal Access Token Section -->
      <div class="pat-section">
        <h3>Personal Access Token</h3>
        <div class="form-group">
          <label for="personalAccessToken"
            >Azure DevOps Personal Access Token</label
          >
          <input
            type="password"
            id="personalAccessToken"
            name="personalAccessToken"
            [(ngModel)]="personalAccessToken"
            required
            placeholder="Enter your Azure DevOps Personal Access Token"
            class="form-control"
          />
        </div>
        <button
          type="button"
          class="btn btn-update-pat"
          [disabled]="!personalAccessToken.trim()"
          (click)="onUpdatePAT()"
        >
          Update PAT
        </button>
      </div>

      <!-- Beta Features Section -->
      <div class="beta-features-section">
        <h3>Beta Features</h3>
        <div class="form-group">
          <div class="beta-toggle-container" (click)="onToggleBetaFeatures()">
            <input
              type="checkbox"
              id="betaFeaturesEnabled"
              name="betaFeaturesEnabled"
              [(ngModel)]="betaFeaturesEnabled"
              class="beta-checkbox"
            />
            <span class="beta-toggle-slider"></span>
            <span class="beta-toggle-label"> Enable Beta Features </span>
          </div>
          <small class="form-help">
            Enable experimental features like Pipelines and Feedback. These
            features are in development and may not work as expected.
          </small>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">
        Close
      </button>
    </div>
  </div>
</div>
