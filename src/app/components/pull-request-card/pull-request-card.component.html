<div
  class="pull-request-card clickable"
  [style.border-left-color]="getRepositoryColor(pullRequest.repository.name)"
  [style.border-left-width]="'4px'"
  (click)="onPullRequestClick()"
  title="Click to open in Azure DevOps"
>
  <div class="pr-header">
    <h3 class="pr-title">
      {{ pullRequest.title }}
      @if (pullRequest.isDraft) {
      <span class="pr-draft-indicator">Draft</span>
      }
    </h3>
    <div class="pr-actions">
      <button
        class="select-btn"
        [class.selected]="isSelected()"
        [disabled]="isSelectionDisabled()"
        (click)="onCheckboxChange($event)"
        [title]="
          isSelectionDisabled()
            ? 'Maximum 2 PRs can be selected'
            : isSelected()
            ? 'Deselect PR from multi-post'
            : 'Select PR for multi-post'
        "
      >
        {{ isSelected() ? "✓" : "+" }}
      </button>
      <button
        class="teams-btn"
        (click)="onTeamsClick($event)"
        title="Copy PR message to clipboard and open Teams channel"
      >
        Post
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="14"
          viewBox="0 0 16 16"
          fill="white"
        >
          <g fill="currentColor">
            <path
              d="M10.768 4.112A2.114 2.114 0 018.65 6.226a2.114 2.114 0 01-2.116-2.112C6.535 2.946 7.482 2 8.65 2s2.117.946 2.117 2.112zM13.21 6.225c.808 0 1.464-.655 1.464-1.462 0-.808-.655-1.463-1.465-1.463a1.464 1.464 0 100 2.925zM14.381 6.875c.342 0 .619.276.619.617v3.288a2.272 2.272 0 01-2.274 2.27h-.01c-.346 0-.673-.077-.966-.214A3.673 3.673 0 018.488 15a3.669 3.669 0 01-3.581-3.75h1.475V6.875h8z"
            />
            <path
              fill-rule="evenodd"
              d="M7.566 4.925h-5.97A.596.596 0 001 5.521v5.958c0 .33.267.596.597.596h5.969c.33 0 .597-.267.597-.596V5.521a.596.596 0 00-.597-.596zM4.959 7.193h1.193v-.63H3.011v.63h1.188v3.243h.76V7.193z"
              clip-rule="evenodd"
            />
          </g>
        </svg>
      </button>
      <span class="pr-id">#{{ pullRequest.pullRequestId }}</span>
    </div>
  </div>

  <div class="pr-details">
    <div class="pr-meta">
      <span class="pr-author">
        <strong>Author:</strong> {{ pullRequest.createdBy.displayName }}
      </span>
      <span class="pr-date">
        <strong>Created:</strong> {{ formatDate(pullRequest.creationDate) }}
      </span>
      <span class="pr-repository">
        <strong>Repository:</strong>
        <span
          class="repo-name"
          [style.background-color]="
            getRepositoryLightColor(pullRequest.repository.name)
          "
          [style.color]="getRepositoryColor(pullRequest.repository.name)"
          [style.border]="
            '1px solid ' + getRepositoryColor(pullRequest.repository.name)
          "
        >
          {{ pullRequest.repository.name }}
        </span>
      </span>
    </div>

    <div class="pr-roadmap-section">
      <div class="roadmap-steps">
        <div
          class="roadmap-step"
          [ngClass]="getRoadmapStepClass(pullRequest, 1)"
        >
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-title">Merge Conflicts</div>
            <div class="step-status">
              {{ getMergeStatus(pullRequest).label }}
            </div>
          </div>
          <div class="step-indicator">
            @if (getRoadmapStepClass(pullRequest, 1) === 'current') {
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0,0,256,256"
            >
              <g
                fill="currentColor"
                fill-rule="nonzero"
                stroke="none"
                stroke-width="1"
                stroke-linecap="butt"
                stroke-linejoin="miter"
                stroke-miterlimit="10"
                stroke-dasharray=""
                stroke-dashoffset="0"
                font-family="none"
                font-weight="none"
                font-size="none"
                text-anchor="none"
                style="mix-blend-mode: normal"
              >
                <g transform="scale(8,8)">
                  <path
                    d="M16,4c-6.61719,0 -12,5.38281 -12,12c0,6.61719 5.38281,12 12,12c6.61719,0 12,-5.38281 12,-12c0,-6.61719 -5.38281,-12 -12,-12zM16,6c5.53516,0 10,4.46484 10,10c0,5.53516 -4.46484,10 -10,10c-5.53516,0 -10,-4.46484 -10,-10c0,-5.53516 4.46484,-10 10,-10zM15,8v9h7v-2h-5v-7z"
                  ></path>
                </g>
              </g>
            </svg>
            } @else {
            {{ getRoadmapStepIcon(pullRequest, 1) }}
            }
          </div>
        </div>

        <div
          class="roadmap-connector"
          [ngClass]="{ completed: isRoadmapStepComplete(pullRequest, 1) }"
        ></div>

        <div
          class="roadmap-step"
          [ngClass]="getRoadmapStepClass(pullRequest, 2)"
        >
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-title">Comments</div>
            <div class="step-status">
              {{ getCommentStatus(pullRequest).label }}
            </div>
          </div>
          <div class="step-indicator">
            @if (getRoadmapStepClass(pullRequest, 2) === 'current') {
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0,0,256,256"
            >
              <g
                fill="currentColor"
                fill-rule="nonzero"
                stroke="none"
                stroke-width="1"
                stroke-linecap="butt"
                stroke-linejoin="miter"
                stroke-miterlimit="10"
                stroke-dasharray=""
                stroke-dashoffset="0"
                font-family="none"
                font-weight="none"
                font-size="none"
                text-anchor="none"
                style="mix-blend-mode: normal"
              >
                <g transform="scale(8,8)">
                  <path
                    d="M16,4c-6.61719,0 -12,5.38281 -12,12c0,6.61719 5.38281,12 12,12c6.61719,0 12,-5.38281 12,-12c0,-6.61719 -5.38281,-12 -12,-12zM16,6c5.53516,0 10,4.46484 10,10c0,5.53516 -4.46484,10 -10,10c-5.53516,0 -10,-4.46484 -10,-10c0,-5.53516 4.46484,-10 10,-10zM15,8v9h7v-2h-5v-7z"
                  ></path>
                </g>
              </g>
            </svg>
            } @else {
            {{ getRoadmapStepIcon(pullRequest, 2) }}
            }
          </div>
        </div>

        <div
          class="roadmap-connector"
          [ngClass]="{ completed: isRoadmapStepComplete(pullRequest, 2) }"
        ></div>

        <div
          class="roadmap-step"
          [ngClass]="getRoadmapStepClass(pullRequest, 3)"
        >
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-title">Reviewers</div>
            <div class="step-status">
              {{ getReviewerCountText(pullRequest) }}
              @if (hasReviewerDetails(pullRequest)) {
              <div class="reviewer-avatars-inline">
                @for (reviewerInfo of getAllReviewersWithStatus(pullRequest);
                track reviewerInfo.reviewer.id) {
                <div
                  class="reviewer-avatar-container"
                  [attr.data-status]="reviewerInfo.status"
                  [title]="
                    reviewerInfo.reviewer.displayName +
                    ' - ' +
                    (reviewerInfo.status === 'approved'
                      ? 'Approved'
                      : reviewerInfo.status === 'rejected'
                      ? 'Rejected'
                      : 'Waiting for review')
                  "
                >
                  <img
                    class="reviewer-avatar"
                    [src]="getReviewerProfilePictureUrl(reviewerInfo.reviewer)"
                    [alt]="reviewerInfo.reviewer.displayName"
                    (error)="onImageError($event)"
                  />
                  <div
                    class="status-indicator"
                    [ngClass]="'status-' + reviewerInfo.status"
                  >
                    @if (reviewerInfo.status === 'approved') {
                    <span class="status-icon">✓</span>
                    } @else if (reviewerInfo.status === 'rejected') {
                    <span class="status-icon">✗</span>
                    } @else {
                    <svg
                      class="status-icon"
                      xmlns="http://www.w3.org/2000/svg"
                      width="10"
                      height="10"
                      viewBox="0,0,256,256"
                    >
                      <g
                        fill="#ffffff"
                        fill-rule="nonzero"
                        stroke="none"
                        stroke-width="1"
                        stroke-linecap="butt"
                        stroke-linejoin="miter"
                        stroke-miterlimit="10"
                        stroke-dasharray=""
                        stroke-dashoffset="0"
                        font-family="none"
                        font-weight="none"
                        font-size="none"
                        text-anchor="none"
                        style="mix-blend-mode: normal"
                      >
                        <g transform="scale(10.66667,10.66667)">
                          <path
                            d="M12,2c-5.514,0 -10,4.486 -10,10c0,5.514 4.486,10 10,10c5.514,0 10,-4.486 10,-10c0,-5.514 -4.486,-10 -10,-10zM15.566,15.989l-4.887,-3.383l0.708,-6.73l2.486,0.262l-0.553,5.256l3.668,2.54z"
                          ></path>
                        </g>
                      </g>
                    </svg>
                    }
                  </div>
                </div>
                }
              </div>
              }
            </div>
          </div>
          <div class="step-indicator">
            @if (getRoadmapStepClass(pullRequest, 3) === 'current') {
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0,0,256,256"
            >
              <g
                fill="currentColor"
                fill-rule="nonzero"
                stroke="none"
                stroke-width="1"
                stroke-linecap="butt"
                stroke-linejoin="miter"
                stroke-miterlimit="10"
                stroke-dasharray=""
                stroke-dashoffset="0"
                font-family="none"
                font-weight="none"
                font-size="none"
                text-anchor="none"
                style="mix-blend-mode: normal"
              >
                <g transform="scale(8,8)">
                  <path
                    d="M16,4c-6.61719,0 -12,5.38281 -12,12c0,6.61719 5.38281,12 12,12c6.61719,0 12,-5.38281 12,-12c0,-6.61719 -5.38281,-12 -12,-12zM16,6c5.53516,0 10,4.46484 10,10c0,5.53516 -4.46484,10 -10,10c-5.53516,0 -10,-4.46484 -10,-10c0,-5.53516 4.46484,-10 10,-10zM15,8v9h7v-2h-5v-7z"
                  ></path>
                </g>
              </g>
            </svg>
            } @else {
            {{ getRoadmapStepIcon(pullRequest, 3) }}
            }
          </div>
        </div>

        <div
          class="roadmap-connector"
          [ngClass]="{ completed: isRoadmapStepComplete(pullRequest, 3) }"
        ></div>

        <div
          class="roadmap-step"
          [ngClass]="getRoadmapStepClass(pullRequest, 4)"
        >
          <div class="step-number">4</div>
          <div class="step-content">
            <div class="step-title">Ready to merge</div>
            <div class="step-status">
              {{ pullRequest.status === "completed" ? "Completed" : "Pending" }}
            </div>
          </div>
          <div class="step-indicator">
            @if (getRoadmapStepClass(pullRequest, 4) === 'current') {
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0,0,256,256"
            >
              <g
                fill="currentColor"
                fill-rule="nonzero"
                stroke="none"
                stroke-width="1"
                stroke-linecap="butt"
                stroke-linejoin="miter"
                stroke-miterlimit="10"
                stroke-dasharray=""
                stroke-dashoffset="0"
                font-family="none"
                font-weight="none"
                font-size="none"
                text-anchor="none"
                style="mix-blend-mode: normal"
              >
                <g transform="scale(8,8)">
                  <path
                    d="M16,4c-6.61719,0 -12,5.38281 -12,12c0,6.61719 5.38281,12 12,12c6.61719,0 12,-5.38281 12,-12c0,-6.61719 -5.38281,-12 -12,-12zM16,6c5.53516,0 10,4.46484 10,10c0,5.53516 -4.46484,10 -10,10c-5.53516,0 -10,-4.46484 -10,-10c0,-5.53516 4.46484,-10 10,-10zM15,8v9h7v-2h-5v-7z"
                  ></path>
                </g>
              </g>
            </svg>
            } @else {
            {{ getRoadmapStepIcon(pullRequest, 4) }}
            }
          </div>
        </div>
      </div>
    </div>

    <div class="pr-branches">
      <span class="branch source">{{
        getBranchName(pullRequest.sourceRefName)
      }}</span>
      <span class="arrow">→</span>
      <span class="branch target">{{
        getBranchName(pullRequest.targetRefName)
      }}</span>
    </div>

    @if (cleanDescription(pullRequest.description)) {
    <div class="pr-description">
      <strong>Description:</strong>
      <p>{{ cleanDescription(pullRequest.description) }}</p>
    </div>
    } @if (getRelatedPullRequests(pullRequest).length > 0 && false) {
    <div class="pr-related">
      <strong>Potentially Related:</strong>
      <div class="related-prs">
        @for (relatedPr of getRelatedPullRequests(pullRequest); track
        relatedPr.pullRequestId) {
        <div
          class="related-pr-item"
          (click)="onRelatedPullRequestClick(relatedPr, $event)"
          title="Click to open {{ relatedPr.title }} in {{
            relatedPr.repository.name
          }}"
        >
          <span
            class="related-repo-dot"
            [style.background-color]="
              getRepositoryColor(relatedPr.repository.name)
            "
          ></span>
          <div class="related-pr-content">
            <span class="related-pr-title">{{ relatedPr.title }}</span>
            <span class="related-pr-repo">{{ relatedPr.repository.name }}</span>
          </div>
          <span class="related-pr-id">#{{ relatedPr.pullRequestId }}</span>
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>
